{
  "hash": "da3b43f4e40b12081a29374b1f3d0fb6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Day 1 – Spatial & Spatio-temporal Modelling\"\nfreeze: auto\nauthor: \"Olatunji Johnson\"\nformat: html\neditor: visual\n---\n\n\n\n\n## \n\n\n\n\n---\ntitle: \"Day 1 – Spatial & Spatio-temporal Modelling\"\n---\n\n\n\n\n## Overview\n\nOn Day 1 we will:\n\n-   Load the spatial malaria datasets\n-   Work with UTM coordinates\n-   Build SPDE meshes\n-   Fit spatial and spatio-temporal models with **inlabru**\n\n\n## Load data (once CSVs are in data/)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(INLA)\nlibrary(inlabru)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(stars)\n\nspatial_binom <- read_csv(\"data/spatial_binomial_data.csv\")\nhead(spatial_binom)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 10\n     id   utm_x    utm_y n_tested n_pos prevalence_true       S elevation  ndvi\n  <dbl>   <dbl>    <dbl>    <dbl> <dbl>           <dbl>   <dbl>     <dbl> <dbl>\n1     1 385648. 1454675.      182    72           0.351  0.0139    363.   0.934\n2     2  58859. 1077815.       64    30           0.632  0.680     165.   0.827\n3     3 437997.  476112.       67    17           0.287  0.489     359.   0.158\n4     4 380293. 1341662.      188    77           0.419 -0.101       8.90 0.981\n5     5 319034.  570466.       97    22           0.272 -0.244     484.   0.941\n6     6 980518.  974256.       88    48           0.427  0.809     474.   0.173\n# ℹ 1 more variable: urban <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n## Quick plot of locations (UTM)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(spatial_binom, aes(utm_x, utm_y, colour = n_pos / n_tested)) +\ngeom_point() +\ncoord_equal() +\nscale_colour_viridis_c(name = \"Prevalence\") +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](day1_spatial_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n## Build the SPDE mesh on UTM coordinates\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Coordinates matrix for mesh\ncoords <- cbind(spatial_binom$utm_x, spatial_binom$utm_y)\n\n# Create a 2D mesh (tune max.edge / cutoff as needed)\nmesh <- inla.mesh.2d(\n  loc = coords,\n  max.edge = c(100000, 300000),   # in metres (since UTM)\n  cutoff  = 20000,                # min distance between points\n  offset  = c(50000, 200000)      # inner/outer extension of mesh\n)\n\nplot(mesh)\npoints(coords, col = \"red\", pch = 16, cex = 0.6)\n```\n\n::: {.cell-output-display}\n![](day1_spatial_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\n## Convert data to sf object\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspatial_binom_sf <- spatial_binom %>% st_as_sf(coords = c(\"utm_x\", \"utm_y\"), crs =  32632)\n```\n:::\n\n\n\n\n## Define the SPDE model (PC prior)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde <- inla.spde2.pcmatern(\n  mesh = mesh,\n  prior.range = c(300000, 0.5),  # P(range < 300 km) = 0.5\n  prior.sigma = c(1.0, 0.01)     # P(sigma > 1) = 0.01\n)\n```\n:::\n\n\n\n\n\n## Define the inlabru components\n\nWe model:\n\n- Fixed effects for elevation, ndvi, urban\n\n- A spatial random field `field(geometry, model = spde)`\n\n- An intercept\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomponents <- ~\n  Intercept(1, model = \"linear\") +\n  beta_elev(elevation, model = \"linear\") +\n  beta_ndvi(ndvi, model = \"linear\") +\n  beta_urban(urban, model = \"linear\") +\n  field(geometry, model = spde)\n\nlik <- like(family = \"binomial\", data = spatial_binom_sf, Ntrials = n_tested,\n            formula = n_pos  ~\n  Intercept +\n  beta_elev +\n  beta_ndvi +\n  beta_urban +\n  field)\n```\n:::\n\n\n\n\n## Fit the spatial binomial model\nResponse = `n_pos`, trials = `n_tested`, family = \"binomial\".\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_spatial_binom <- bru(\n  components = components,\n  lik,\n  options    = list(\n    control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE)\n  )\n)\n\nfit_spatial_binom\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nIntercept: main = linear(1)\nbeta_elev: main = linear(elevation)\nbeta_ndvi: main = linear(ndvi)\nbeta_urban: main = linear(urban)\nfield: main = spde(geometry)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: n_pos ~ Intercept + beta_elev + beta_ndvi + beta_urban + field\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[Intercept, beta_elev, beta_ndvi, beta_urban, field], latent[] \nTime used:\n    Pre = 0.742, Running = 1.74, Post = 0.211, Total = 2.69 \nFixed effects:\n             mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nIntercept  -0.875 0.120     -1.110   -0.875     -0.638 -0.875   0\nbeta_elev  -0.001 0.000     -0.001   -0.001      0.000 -0.001   0\nbeta_ndvi   0.418 0.119      0.183    0.418      0.651  0.418   0\nbeta_urban  0.023 0.087     -0.149    0.023      0.194  0.023   0\n\nRandom effects:\n  Name\t  Model\n    field SPDE2 model\n\nModel hyperparameters:\n                    mean       sd 0.025quant 0.5quant 0.975quant     mode\nRange for field 51121.52 8029.258   36685.15 50655.06   68199.89 50014.00\nStdev for field     1.26    0.109       1.07     1.26       1.50     1.24\n\nDeviance Information Criterion (DIC) ...............: 1850.10\nDeviance Information Criterion (DIC, saturated) ....: 640.78\nEffective number of parameters .....................: 191.37\n\nWatanabe-Akaike information criterion (WAIC) ...: 2348.40\nEffective number of parameters .................: 404.89\n\nMarginal log-Likelihood:  -1241.98 \nCPO, PIT is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fit_spatial_binom)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nIntercept: main = linear(1)\nbeta_elev: main = linear(elevation)\nbeta_ndvi: main = linear(ndvi)\nbeta_urban: main = linear(urban)\nfield: main = spde(geometry)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: n_pos ~ Intercept + beta_elev + beta_ndvi + beta_urban + field\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[Intercept, beta_elev, beta_ndvi, beta_urban, field], latent[] \nTime used:\n    Pre = 0.742, Running = 1.74, Post = 0.211, Total = 2.69 \nFixed effects:\n             mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nIntercept  -0.875 0.120     -1.110   -0.875     -0.638 -0.875   0\nbeta_elev  -0.001 0.000     -0.001   -0.001      0.000 -0.001   0\nbeta_ndvi   0.418 0.119      0.183    0.418      0.651  0.418   0\nbeta_urban  0.023 0.087     -0.149    0.023      0.194  0.023   0\n\nRandom effects:\n  Name\t  Model\n    field SPDE2 model\n\nModel hyperparameters:\n                    mean       sd 0.025quant 0.5quant 0.975quant     mode\nRange for field 51121.52 8029.258   36685.15 50655.06   68199.89 50014.00\nStdev for field     1.26    0.109       1.07     1.26       1.50     1.24\n\nDeviance Information Criterion (DIC) ...............: 1850.10\nDeviance Information Criterion (DIC, saturated) ....: 640.78\nEffective number of parameters .....................: 191.37\n\nWatanabe-Akaike information criterion (WAIC) ...: 2348.40\nEffective number of parameters .................: 404.89\n\nMarginal log-Likelihood:  -1241.98 \nCPO, PIT is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\nYou’ll see posterior summaries for:\n- Intercept\n- beta_elev, beta_ndvi, beta_urban\n- SPDE hyperparameters (range, sigma)\n\n\n## Make predictions on a grid (prevalence surface)\n\nWe start by loading the prediction grid with UTM coords and covariates. Also,\nconvert it to sf object.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_grid <- read_csv(\"data/prediction_grid_utm.csv\") %>% \n  st_as_sf(coords = c(\"utm_x\", \"utm_y\"), crs =  32632)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Logistic helper\nlogistic <- function(x) 1 / (1 + exp(-x))\n\n# Prediction: posterior mean of prevalence\npred_res <- predict(\n  fit_spatial_binom,\n  newdata = pred_grid,\n  formula = ~ logistic(\n    Intercept +\n      beta_elev * elevation +\n      beta_ndvi * ndvi +\n      beta_urban * urban +\n      field\n  ),\n  n.samples = 1000   # increase for smoother estimates\n)\n\n# Combine predictions with grid\nnames(pred_res)[names(pred_res) == \"mean\"] <- \"prev_mean\"\nnames(pred_res)[names(pred_res) == \"sd\"]   <- \"prev_sd\"\n```\n:::\n\n\n\n\n\n## Plot the predicted prevalence surface\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# choose an appropriate resolution (in metres, since UTM)\npred_rast <- st_rasterize(pred_res[\"prev_mean\"], dx = 10000, dy = 10000)\n\nggplot() +\n  geom_stars(data = pred_rast) +\n  coord_equal() +\n  scale_fill_viridis_c(name = \"Predicted\\nprevalence\") +\n  theme_minimal() +\n  labs(\n    title = \"Posterior mean malaria prevalence\",\n    subtitle = \"Spatial binomial model (inlabru, SPDE on UTM)\"\n  )\n```\n\n::: {.cell-output-display}\n![](day1_spatial_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\nAnd (optionally) overlay the sampling locations:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_stars(data = pred_rast) +\n  geom_sf(\n    data = spatial_binom_sf,\n    colour = \"red\",\n    size = 0.6\n  ) +\n  coord_sf() +\n  scale_fill_viridis_c(name = \"Predicted\\nprevalence\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](day1_spatial_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Exceedance probability\nFirst, get posterior samples of prevalence on the grid.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Recompute predictions but keep samples\npred_res_samples <- generate(\n  fit_spatial_binom,\n  newdata = pred_grid,\n  formula = ~ logistic(\n    Intercept +\n      beta_elev * elevation +\n      beta_ndvi * ndvi +\n      beta_urban * urban +\n      field\n  ),\n  n.samples = 1000\n)\n\n# pred_res_samples is a data.frame with summary stats\n# and an attribute \".samples\" containing the draws\nstr(pred_res_samples)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n num [1:40000, 1:1000] 0.20266 0.2448 0.00237 0.03545 0.00122 ...\n```\n\n\n:::\n:::\n\n\n\n\n## Compute exceedance probability P(prevalence > 0.3)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Threshold\nthreshold <- 0.3\n\n# Exceedance probability at each location\npred_res$exc_prob <- rowMeans(pred_res_samples > threshold)\n\npred_rast_exc <- st_rasterize(pred_res[\"exc_prob\"], dx = 10000, dy = 10000)\n```\n:::\n\n\n\n\n## Plot the exceedance probability map\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_stars(data = pred_rast_exc) +\n  coord_equal() +\n  scale_fill_viridis_c(\n    name = \"P(prev > 0.3)\",\n    limits = c(0, 1)\n  ) +\n  theme_minimal() +\n  labs(\n    title = \"Exceedance probability: P(prevalence > 0.3)\",\n    subtitle = \"Spatial binomial inlabru model\"\n  )\n```\n\n::: {.cell-output-display}\n![](day1_spatial_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n## Highlight the 0.8 exceedance contour\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_stars(data = pred_rast_exc) +\n  scale_fill_viridis_c(\n    name = \"P(prev > 0.3)\",\n    limits = c(0, 1)\n  ) +\n  coord_equal() +\n  # contour applied to stars layer\n  geom_contour(\n    data = as.data.frame(pred_rast_exc, xy = TRUE),\n    aes(x = x, y = y, z = exc_prob),\n    breaks = 0.8,\n    colour = \"red\",\n    linewidth = 0.6\n  ) +\n  theme_minimal() +\n  labs(\n    title = \"Exceedance probability with 0.8 contour\",\n    subtitle = \"Spatial binomial model\"\n  )\n```\n\n::: {.cell-output-display}\n![](day1_spatial_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}