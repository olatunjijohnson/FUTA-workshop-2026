{
  "hash": "c3900f1438ea01bcb916ccb59ce5f37e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Day 1 – Spatial & Spatio-Temporal Modelling\"\nauthor: \"Olatunji Johnson\"\nfreeze: auto\nformat: html\neditor: visual\n---\n\n\n\n\n# Overview\n\nToday we introduce modern geostatistical modelling using inlabru, covering:\n\n1.  Spatial models\n\n    -   Binomial likelihood (prevalence)\n    -   Poisson likelihood (case counts)\n    -   SPDE spatial random fields\n    -   Prediction surfaces\n    -   Exceedance probabilities\n\n2.  Spatio-temporal models\n\n    -   Handling time-indexed disease data\n    -   RW1/RW2 temporal structure\n    -   Spatio-temporal Gaussian fields\n    -   Predicting in time and space\n\nThese form the foundation for Days 2 and 3.\n\n============================================================\n\n**PART A — Spatial models**\n\n============================================================\n\n## 1. Load data\n\nThese data were generated during preprocessing and saved to data/\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(INLA)\nlibrary(inlabru)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(stars)\nlibrary(rnaturalearth)\nlibrary(rnaturalearthdata)\n\nnga_admin1 <- ne_states(\"Nigeria\", returnclass = \"sf\") %>%\nst_transform(32632)\n\nspatial_binom <- read_csv(\"data/spatial_binomial_data.csv\")\nspatial_pois  <- read_csv(\"data/spatial_poisson_data.csv\")\n```\n:::\n\n\n\n\n## 2. Convert to sf for mapping\n\nWe need an `sf` layer to overlay boundaries, plot points, and feed coordinates into SPDE meshes.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspatial_binom_sf <- spatial_binom %>%\n  st_as_sf(coords = c(\"utm_x\", \"utm_y\"), crs = 32632)\nspatial_pois_sf <- spatial_pois %>%\n  st_as_sf(coords = c(\"utm_x\", \"utm_y\"), crs = 32632)\n```\n:::\n\n\n\n\n## 3. Visualise sampling locations\n\nThis helps confirm:\n\n-   UTM conversion is correct\n-   Points sit inside Nigeria\n-   Prevalence has spatial structure\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\ngeom_sf(data = spatial_binom_sf, aes(colour = prevalence_true)) +\ngeom_sf(data = nga_admin1, fill = NA) +\nscale_colour_viridis_c(name=\"Prevalence\") +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](day1_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\n## 4. Build the SPDE mesh\n\nThe mesh defines the geometry on which the latent spatial field is approximated.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoords <- st_coordinates(spatial_binom_sf)\n\nmesh <- inla.mesh.2d(\nloc = coords,\nmax.edge = c(100000, 200000), # inner and outer triangle sizes\ncutoff = 20000,  # merge points closer than 20km\noffset = c(50000, 200000)  # extend mesh beyond convex hull\n)\n\nplot(mesh)\npoints(coords, col=\"red\", pch=16)\n```\n\n::: {.cell-output-display}\n![](day1_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\nA finer mesh → more accurate, more expensive.\\\nA coarser mesh → faster, less precise.\\\nWe balance cost vs smoothness.\n\n## 5. SPDE model (PC priors)\n\nPenalised complexity (PC) priors make spatial models robust and interpretable.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde <- inla.spde2.pcmatern(\nmesh = mesh,\nprior.range = c(300000, 0.5),\nprior.sigma = c(1.0, 0.01)\n)\n```\n:::\n\n\n\n\n## 6. Spatial BINOMIAL model\n\nThe model is:\n\n$$logit(pi​)=\\beta_0​+\\beta_1​ elevation_i​+ \\beta_2​ndvi_i​+ \\beta_3 ​urban_i​+ S(s_i​)$$\n\nWhere $S(\\mathbf{s})$ is a spatial Gaussian field.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomponents_binom <- ~\nIntercept(1, model=\"linear\") +\nbeta_elev(elevation, model=\"linear\") +\nbeta_ndvi(ndvi, model=\"linear\") +\nbeta_urban(urban, model=\"linear\") +\nfield(geometry, model = spde)\n\nlik_binom <- like(\nfamily=\"binomial\",\ndata=spatial_binom_sf,\nformula = n_pos ~ Intercept + beta_elev + beta_ndvi + beta_urban + field,\nNtrials = n_tested\n)\n\n#| cache: true\nfit_binom <- bru(components_binom, lik_binom)\nsummary(fit_binom)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nIntercept: main = linear(1)\nbeta_elev: main = linear(elevation)\nbeta_ndvi: main = linear(ndvi)\nbeta_urban: main = linear(urban)\nfield: main = spde(geometry)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: n_pos ~ Intercept + beta_elev + beta_ndvi + beta_urban + field\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[Intercept, beta_elev, beta_ndvi, beta_urban, field], latent[] \nTime used:\n    Pre = 0.797, Running = 1.19, Post = 0.195, Total = 2.19 \nFixed effects:\n             mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nIntercept  -3.464 0.779     -5.034   -3.452     -1.965 -3.453   0\nbeta_elev  -0.003 0.001     -0.006   -0.003      0.000 -0.003   0\nbeta_ndvi   5.350 1.305      2.796    5.340      7.962  5.341   0\nbeta_urban  0.456 0.059      0.341    0.456      0.572  0.456   0\n\nRandom effects:\n  Name\t  Model\n    field SPDE2 model\n\nModel hyperparameters:\n                    mean       sd 0.025quant 0.5quant 0.975quant     mode\nRange for field 2.79e+05 4.70e+04   2.01e+05 2.74e+05   3.86e+05 2.62e+05\nStdev for field 1.12e+00 1.34e-01   8.90e-01 1.11e+00   1.42e+00 1.08e+00\n\nMarginal log-Likelihood:  -935.76 \n is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\n## 7. Spatial POISSON model\n\nOften used for malaria case counts or incidence.\n\nModel: $$\\log(\\lambda_i)= \\beta_0 + \\beta_1 X_i + S(s_i)$$\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomponents_pois <- ~\nIntercept(1, model=\"linear\") +\nbeta_elev(elevation, model=\"linear\") +\nbeta_ndvi(ndvi, model=\"linear\") +\nbeta_urban(urban, model=\"linear\") +\nfield(geometry, model = spde)\n\nlik_pois <- like(\nfamily=\"poisson\",\ndata=spatial_pois_sf,\nformula = cases ~ Intercept + beta_elev + beta_ndvi + beta_urban + field\n)\n\n#| cache: true\nfit_pois <- bru(components_pois, lik_pois)\nsummary(fit_pois)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nIntercept: main = linear(1)\nbeta_elev: main = linear(elevation)\nbeta_ndvi: main = linear(ndvi)\nbeta_urban: main = linear(urban)\nfield: main = spde(geometry)\nObservation models:\n  Model tag: <No tag>\n    Family: 'poisson'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: cases ~ Intercept + beta_elev + beta_ndvi + beta_urban + field\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[Intercept, beta_elev, beta_ndvi, beta_urban, field], latent[] \nTime used:\n    Pre = 0.752, Running = 0.933, Post = 0.246, Total = 1.93 \nFixed effects:\n             mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nIntercept   0.530 0.617     -0.661    0.523      1.766  0.523   0\nbeta_elev  -0.001 0.002     -0.004   -0.001      0.002 -0.001   0\nbeta_ndvi   1.432 0.731     -0.063    1.449      2.829  1.448   0\nbeta_urban  0.747 0.082      0.587    0.747      0.909  0.747   0\n\nRandom effects:\n  Name\t  Model\n    field SPDE2 model\n\nModel hyperparameters:\n                    mean      sd 0.025quant 0.5quant 0.975quant     mode\nRange for field 1.34e+05 3.7e+04   7.56e+04 1.29e+05   2.20e+05 1.19e+05\nStdev for field 8.23e-01 9.4e-02   6.54e-01 8.18e-01   1.02e+00 8.07e-01\n\nMarginal log-Likelihood:  -631.40 \n is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\n## 8. Predictive surfaces (binomial example)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_grid <- read_csv(\"data/prediction_grid_utm.csv\") %>%\nst_as_sf(coords=c(\"utm_x\",\"utm_y\"), crs=32632)\n\npred_binom <- predict(\nfit_binom,\nnewdata = pred_grid,\nformula = ~ plogis(Intercept + beta_elev + beta_ndvi + beta_urban + field),\nn.samples = 1000\n)\n```\n:::\n\n\n\n\nRasterise:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_binom_r <- st_rasterize(pred_binom[\"mean\"], dx=10000, dy=10000)\npred_binom_r <- pred_binom_r[st_union(nga_admin1)]\n```\n:::\n\n\n\n\nPlot:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_stars(data=pred_binom_r, na.rm = TRUE) +\n  scale_fill_viridis_c(name=\"Prev\", na.value = NA) +\n  geom_sf(data=nga_admin1, fill=NA) +\n  theme_minimal() +\n  theme(\n    panel.background = element_rect(fill = \"white\", colour = NA),\n    plot.background  = element_rect(fill = \"white\", colour = NA),\n    panel.grid       = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](day1_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n## 9. Exceedance probability (binomial)\n\nGoal:\n\n$$P(prevalence>0.5∣data)$$\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexc_samples <- generate(\nfit_binom,\nnewdata = pred_grid,\nformula = ~ plogis(Intercept + beta_elev + beta_ndvi + beta_urban + field),\nn.samples = 1000\n)\n\npred_binom$exc_prob <- rowMeans(exc_samples > 0.5)\n```\n:::\n\n\n\n\nMap:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexc_r <- st_rasterize(pred_binom[\"exc_prob\"], dx=10000, dy=10000)\nexc_r <- exc_r[st_union(nga_admin1)]\n\nggplot() +\n  geom_stars(data=exc_r, na.rm = TRUE) +\n  scale_fill_viridis_c(name=\"P(prev>0.5)\", limits=c(0,1), na.value = NA) +\n  geom_sf(data=nga_admin1, fill=NA) +\n  theme_minimal() + \n  theme(\n    panel.background = element_rect(fill = \"white\", colour = NA),\n    plot.background  = element_rect(fill = \"white\", colour = NA),\n    panel.grid       = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](day1_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n\n============================================================\n\n**PART B — Spatio-Temporal Modelling** ============================================================\n\nWe now extend:\n\n$$S(s)⟶S(s,t)$$\n\nA common structure:\n\n1.  Spatial effect: SPDE\n\n2.  Temporal effect: random walk (RW1 or RW2)\n\n3.  Interaction: separable $S(s,t)=S_s(s)+S_t(t)$\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst_binom <- read_csv(\"data/spatiotemporal_binomial_data.csv\") %>%\n  st_as_sf(coords=c(\"utm_x\",\"utm_y\"), crs=32632)\n\nhead(st_binom)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 10 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 336995.7 ymin: 1047442 xmax: 336995.7 ymax: 1047442\nProjected CRS: WGS 84 / UTM zone 32N\n# A tibble: 6 × 11\n   site  time     S gamma_t elevation  ndvi urban n_tested n_pos prevalence_true\n  <dbl> <dbl> <dbl>   <dbl>     <dbl> <dbl> <dbl>    <dbl> <dbl>           <dbl>\n1     1     1 0.266   2.12       228. 0.305     0       63    51           0.774\n2     1     2 0.266   1.50       228. 0.305     0       65    43           0.649\n3     1     3 0.266   0.381      228. 0.305     0      119    52           0.376\n4     1     4 0.266   0.286      228. 0.305     0      191    72           0.354\n5     1     5 0.266   0.168      228. 0.305     0      180    50           0.327\n6     1     6 0.266   0.207      228. 0.305     0      155    52           0.336\n# ℹ 1 more variable: geometry <POINT [m]>\n```\n\n\n:::\n:::\n\n\n\n\nShould contain:\n\n-   time\n\n-   n_tested, n_pos\n\n-   covariates\n\n-   UTM coordinates\n\n## 11. Spatio-temporal components\n\nUse: - RW1 for time - SPDE for space - Additive interaction\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomponents_st <- ~\nIntercept(1, model=\"linear\") +\nbeta_elev(elevation, model=\"linear\") +\nbeta_ndvi(ndvi, model=\"linear\") +\nbeta_urban(urban, model=\"linear\") +\ntime(time, model=\"rw1\") +\nfield(geometry, model = spde)\n```\n:::\n\n\n\n\nLikelihood:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlik_st <- like(\nfamily=\"binomial\",\ndata = st_binom,\nformula = n_pos ~ Intercept + beta_elev + beta_ndvi + beta_urban +\ntime + field,\nNtrials = n_tested\n)\n```\n:::\n\n\n\n\nFit:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_st_binom <- bru(components_st, lik_st)\nsummary(fit_st_binom)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nIntercept: main = linear(1)\nbeta_elev: main = linear(elevation)\nbeta_ndvi: main = linear(ndvi)\nbeta_urban: main = linear(urban)\ntime: main = rw1(time)\nfield: main = spde(geometry)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: n_pos ~ Intercept + beta_elev + beta_ndvi + beta_urban + time + field\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[Intercept, beta_elev, beta_ndvi, beta_urban, time, field], latent[] \nTime used:\n    Pre = 0.697, Running = 0.992, Post = 0.124, Total = 1.81 \nFixed effects:\n             mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nIntercept  -0.261 0.332     -0.909   -0.263      0.399 -0.263   0\nbeta_elev  -0.002 0.001     -0.003   -0.002     -0.001 -0.002   0\nbeta_ndvi   1.775 0.591      0.590    1.781      2.926  1.781   0\nbeta_urban  0.525 0.028      0.470    0.525      0.580  0.525   0\n\nRandom effects:\n  Name\t  Model\n    time RW1 model\n   field SPDE2 model\n\nModel hyperparameters:\n                       mean       sd 0.025quant 0.5quant 0.975quant     mode\nPrecision for time 4.49e+00 2.65e+00   1.25e+00 3.88e+00   1.13e+01 2.85e+00\nRange for field    1.73e+05 2.65e+04   1.28e+05 1.71e+05   2.32e+05 1.65e+05\nStdev for field    6.52e-01 5.20e-02   5.57e-01 6.50e-01   7.61e-01 6.44e-01\n\nMarginal log-Likelihood:  -3963.37 \n is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\n## 12. Predict spatio-temporal prevalence (example: year = 2020)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_grid$time <- 7\n\npred_st <- predict(\nfit_st_binom,\nnewdata = pred_grid,\nformula = ~ plogis(Intercept + beta_elev + beta_ndvi + beta_urban +\ntime + field),\nn.samples = 500\n)\n```\n:::\n\n\n\n\nMap for 2020:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_st_r <- st_rasterize(pred_st[\"mean\"], dx=10000, dy=10000)\n\nggplot() +\n  geom_stars(data = pred_st_r, na.rm = TRUE) +\n  scale_fill_viridis_c(name=\"Prev time 7\", na.value = NA) +\n  geom_sf(data=nga_admin1, fill=NA) +\n  theme_minimal() +\n  theme(\n    panel.background = element_rect(fill = \"white\", colour = NA),\n    plot.background  = element_rect(fill = \"white\", colour = NA),\n    panel.grid       = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](day1_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n# End of Day 1\n\nBy the end of today participants can:\n\n-   Fit spatial binomial and Poisson models\n-   Build meshes and PC priors\n-   Predict over a grid\n-   Generate exceedance probability maps\n-   Fit basic spatio-temporal models using SPDE + RW1\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}