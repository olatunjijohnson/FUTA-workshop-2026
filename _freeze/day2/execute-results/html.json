{
  "hash": "a34acbae32f5b9b02adc84d4bdd14ce5",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Day 2 – Joint modelling and Non-stationary processes\"\nauthor: \"Olatunji Johnson\"\nfreeze: auto\nformat: html\neditor: visual\n---\n\n\n\n\n## Overview\n\nToday we will cover two key advanced topics in spatial modelling:\n\n1.  **Joint modelling** of multiple malaria processes\n    -   Shared spatial fields\\\n    -   Process-specific fields\\\n    -   Multiple outcomes (e.g., children vs pregnant women)\n    -   Multiple likelihoods (Binomial + Poisson)\n2.  **Non-stationary spatial processes**\n    -   Region-varying smoothness\\\n    -   Covariate-driven nonstationarity\\\n    -   Combining multiple spatial SPDEs\n\n------------------------------------------------------------------------\n\n## Load Day 2 datasets\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(INLA)\nlibrary(inlabru)\nlibrary(ggplot2)\nlibrary(sf)\nlibrary(stars)\nlibrary(geoR)\n\njoint_malaria <- read_csv(\"data/joint_malaria_processes.csv\")\nnonstat_malaria <- read_csv(\"data/nonstationary_malaria_data.csv\")\n\nnga_admin1 <- st_read(\"data/nga_shapefile.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `nga_shapefile' from data source \n  `/home/olatunji-johnson/Documents/Manchester Job/Teaching/Courses/Nigeria_2026/rcode/FUTA/data/nga_shapefile.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 37 features and 121 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -198992.3 ymin: 472813 xmax: 1117766 ymax: 1537228\nProjected CRS: WGS 84 / UTM zone 32N\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(joint_malaria)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 12\n     id group    utm_x  utm_y n_tested n_pos prevalence_true S_shared S_specific\n  <dbl> <chr>    <dbl>  <dbl>    <dbl> <dbl>           <dbl>    <dbl>      <dbl>\n1     1 child… 249196. 7.37e5      148    48           0.281   0.297      -0.409\n2     2 child… 703934. 9.57e5      107    35           0.337  -0.0736      0.415\n3     3 child… -90558. 9.32e5      139    66           0.416   0.680      -0.145\n4     4 child… 252087. 1.11e6      138    55           0.369  -0.147       0.277\n5     5 child… 685078. 1.34e6      183    47           0.219  -0.192      -0.281\n6     6 child… 422901. 5.12e5      131    63           0.501   0.589       0.166\n# ℹ 3 more variables: elevation <dbl>, ndvi <dbl>, urban <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n## 2. Convert to sf for mapping\n\nWe need an `sf` layer to overlay boundaries, plot points, and feed coordinates into SPDE meshes.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\njoint_malaria_sf <- joint_malaria %>%\n  st_as_sf(coords = c(\"utm_x\", \"utm_y\"), crs = 32632)\nnonstat_malaria_sf <- nonstat_malaria %>%\n  st_as_sf(coords = c(\"utm_x\", \"utm_y\"), crs = 32632)\n```\n:::\n\n\n\n\nQuick visualisation\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\ngeom_sf(data = joint_malaria_sf, aes(colour = prevalence_true)) +\nfacet_wrap(~group) +\ngeom_sf(data = nga_admin1, fill = NA) +\ngeom_point() +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\nQuick visualisation (non-stationary dataset)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\ngeom_sf(data = nonstat_malaria_sf, aes(colour = prevalence_true)) +\ngeom_sf(data = nga_admin1, fill = NA) +\ngeom_point() +\ntheme_minimal()\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n============================================================\n\n**Part 1A — Joint modelling (shared + group-specific fields)**\n\n============================================================\n\n1.  Create a single stacked dataset\n\nWe will model both groups jointly with: - one shared spatial field - one group-specific spatial field (replicated by group)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\njoint_dat <- joint_malaria_sf |>\nmutate(\ngroup = factor(group),\ny = n_pos,\nn = n_tested\n)\n\nlevels(joint_dat$group)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"children_u5\"    \"pregnant_women\"\n```\n\n\n:::\n:::\n\n\n\n\n2.  Build SPDE mesh\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlocs_joint <- joint_malaria_sf\n\nmesh_joint <- inla.mesh.2d(\nloc = st_coordinates(locs_joint),\nmax.edge = c(80000, 250000),   # tune for smoothness vs speed\ncutoff = 20000,                # remove very close points\noffset = c(100000, 200000)\n)\n\nplot(mesh_joint)\npoints(st_coordinates(locs_joint), pch = 16, cex = 0.4, col= \"red\")\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n3.  Define SPDEs (shared + group-specific)\n\n-   spde_shared: one latent field for all data\n-   spde_group: replicated field with one replicate per group\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde_shared <- inla.spde2.pcmatern(\nmesh = mesh_joint,\nprior.range = c(300000, 0.5),   # P(range < 300km) = 0.5\nprior.sigma = c(1, 0.5)         # P(sigma > 1) = 0.5\n)\n\nspde_group <- inla.spde2.pcmatern(\nmesh = mesh_joint,\nprior.range = c(200000, 0.5),\nprior.sigma = c(1, 0.5)\n)\n```\n:::\n\n\n\n\n4.  Fit joint model in inlabru\n\nModel:\n\n-   Binomial likelihood for counts\n-   Fixed effects (elevation, ndvi, urban)\n-   field_shared() applies to all\n-   field_group() replicated by group\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncmp_joint <- y ~\n1 +\nelevation + ndvi + urban +\nfield_shared(geometry, model = spde_shared) +\nfield_group(geometry, model = spde_group, replicate = group)\n\nfit_joint <- bru(\ncomponents = cmp_joint,\nfamily = \"binomial\",\ndata = joint_dat,\nNtrials = joint_dat$n,\noptions = list(control.compute = list(dic = TRUE, waic = TRUE))\n)\n\nsummary(fit_joint)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nelevation: main = linear(elevation)\nndvi: main = linear(ndvi)\nurban: main = linear(urban)\nfield_shared: main = spde(geometry)\nfield_group: main = spde(geometry), replicate = iid(group)\nIntercept: main = linear(1)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: y ~ elevation + ndvi + urban + field_shared + field_group + Intercept\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[elevation, ndvi, urban, field_shared, field_group, Intercept], latent[] \nTime used:\n    Pre = 1.06, Running = 10.3, Post = 0.419, Total = 11.7 \nFixed effects:\n            mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nelevation -0.002 0.001     -0.003   -0.002      0.000 -0.002   0\nndvi       1.650 0.530      0.617    1.645      2.713  1.646   0\nurban      0.350 0.041      0.269    0.350      0.430  0.350   0\nIntercept -0.396 0.360     -1.113   -0.393      0.304 -0.393   0\n\nRandom effects:\n  Name\t  Model\n    field_shared SPDE2 model\n   field_group SPDE2 model\n\nModel hyperparameters:\n                           mean       sd 0.025quant 0.5quant 0.975quant\nRange for field_shared 5.32e+04 1.62e+04   2.81e+04 5.09e+04   9.12e+04\nStdev for field_shared 3.47e-01 3.60e-02   2.81e-01 3.46e-01   4.23e-01\nRange for field_group  3.41e+05 6.04e+04   2.42e+05 3.34e+05   4.78e+05\nStdev for field_group  5.37e-01 6.50e-02   4.24e-01 5.32e-01   6.78e-01\n                           mode\nRange for field_shared 4.68e+04\nStdev for field_shared 3.43e-01\nRange for field_group  3.19e+05\nStdev for field_group  5.19e-01\n\nDeviance Information Criterion (DIC) ...............: 3183.49\nDeviance Information Criterion (DIC, saturated) ....: 835.78\nEffective number of parameters .....................: 292.18\n\nWatanabe-Akaike information criterion (WAIC) ...: 3175.37\nEffective number of parameters .................: 214.05\n\nMarginal log-Likelihood:  -1807.95 \n is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\n5.  Prediction grid inside Nigeria (UTM)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# make_grid_utm <- function(polygon_utm, dx = 20000) {\n# bb <- st_bbox(polygon_utm)\n# xs <- seq(bb[\"xmin\"], bb[\"xmax\"], by = dx)\n# ys <- seq(bb[\"ymin\"], bb[\"ymax\"], by = dx)\n# grid <- expand.grid(utm_x = xs, utm_y = ys)\n# pts  <- st_as_sf(grid, coords = c(\"utm_x\", \"utm_y\"), crs = st_crs(polygon_utm))\n# inside <- st_within(pts, polygon_utm, sparse = FALSE)[, 1]\n# grid[inside, ]\n# }\n# \n# pred_grid_joint <- make_grid_utm(nga_poly %>% st_transform(32632), dx = 100000) |>\n# mutate(\n# # For teaching: use simple smooth-ish covariates (replace with real rasters later)\n# elevation = 250 + 80 * scale(utm_y)[,1] + rnorm(n(), sd = 15),\n# ndvi      = plogis(-0.2 + 0.8 * scale(utm_y)[,1] + 0.3 * sin(scale(utm_x)[,1])),\n# urban     = rbinom(n(), 1, plogis(-0.2 + 0.3 * scale(utm_x)[,1]))\n# )\n\npred_grid_joint <- read_csv(\"data/prediction_grid_utm.csv\") %>% \ntidyr::expand_grid(group = levels(joint_dat$group)) %>%\nst_as_sf(coords=c(\"utm_x\",\"utm_y\"), crs=32632)\nhead(pred_grid_joint)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 6 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 172259.6 ymin: 478133.5 xmax: 185657.6 ymax: 478184.5\nProjected CRS: WGS 84 / UTM zone 32N\n# A tibble: 6 × 7\n    lon   lat elevation   ndvi urban group                     geometry\n  <dbl> <dbl>     <dbl>  <dbl> <dbl> <chr>                  <POINT [m]>\n1  6.05  4.32      253. 0.0664     1 children_u5    (172259.6 478184.5)\n2  6.05  4.32      253. 0.0664     1 pregnant_women (172259.6 478184.5)\n3  6.11  4.32      244. 0.0654     1 children_u5    (178958.8 478158.8)\n4  6.11  4.32      244. 0.0654     1 pregnant_women (178958.8 478158.8)\n5  6.17  4.32      242. 0.0645     1 children_u5    (185657.6 478133.5)\n6  6.17  4.32      242. 0.0645     1 pregnant_women (185657.6 478133.5)\n```\n\n\n:::\n:::\n\n\n\n\n6.  Predict for each group and map\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_joint <- predict(\nfit_joint,\nnewdata = pred_grid_joint,\nformula = ~ plogis(Intercept + elevation + ndvi + urban +\nfield_shared + field_group),\nn.samples = 200\n)\n\npred_joint_sf <- pred_joint |>\nrename(prev_mean = mean)\n\nhead(pred_joint_sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 14 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: 172259.6 ymin: 478133.5 xmax: 185657.6 ymax: 478184.5\nProjected CRS: WGS 84 / UTM zone 32N\n       lon      lat elevation       ndvi urban          group prev_mean\n1 6.047644 4.320444  252.9367 0.06636150     1    children_u5 0.2454142\n2 6.047644 4.320444  252.9367 0.06636150     1 pregnant_women 0.5502509\n3 6.107940 4.320444  244.1864 0.06535912     1    children_u5 0.2431139\n4 6.107940 4.320444  244.1864 0.06535912     1 pregnant_women 0.5562642\n5 6.168235 4.320444  242.2228 0.06445763     1    children_u5 0.2392009\n6 6.168235 4.320444  242.2228 0.06445763     1 pregnant_women 0.5595819\n          sd    q0.025      q0.5    q0.975    median mean.mc_std_err\n1 0.08483441 0.1175872 0.2320009 0.4295042 0.2320009     0.006635328\n2 0.10346490 0.3383491 0.5534975 0.7451256 0.5534975     0.008062772\n3 0.07796974 0.1296129 0.2322176 0.4115017 0.2322176     0.006096718\n4 0.09640754 0.3675169 0.5628076 0.7359455 0.5628076     0.007501434\n5 0.07206476 0.1319077 0.2296956 0.3944603 0.2296956     0.005632434\n6 0.09133494 0.3860712 0.5576584 0.7322711 0.5576584     0.007085350\n  sd.mc_std_err                  geometry\n1   0.004501648 POINT (172259.6 478184.5)\n2   0.005279958 POINT (172259.6 478184.5)\n3   0.004125433 POINT (178958.8 478158.8)\n4   0.004839379 POINT (178958.8 478158.8)\n5   0.003794938 POINT (185657.6 478133.5)\n6   0.004433520 POINT (185657.6 478133.5)\n```\n\n\n:::\n:::\n\n\n\n\n7.  Raster map per group (clipped to Nigeria)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_joint_map <- function(group_name, dx = 20000) {\ndat_g <- pred_joint_sf |> filter(group == group_name)\n\nrast <- st_rasterize(dat_g[\"prev_mean\"], dx = dx, dy = dx)\nrast_ng <- rast[st_union(nga_admin1)]\n\nggplot() +\ngeom_stars(data = rast_ng, na.rm = TRUE) +\ngeom_sf(data = nga_admin1, fill = NA, colour = \"black\", linewidth = 0.25) +\ncoord_sf(expand = FALSE) +\nscale_fill_viridis_c(name = \"Predicted\\nprevalence\", na.value = NA) +\ntheme_minimal() +\ntheme(panel.grid = element_blank(),\npanel.background = element_rect(fill = \"white\", colour = NA),\nplot.background  = element_rect(fill = \"white\", colour = NA)) +\nlabs(title = paste(\"Joint model: posterior mean prevalence –\", group_name))\n}\n\npred_joint_map(\"children_u5\")\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n\n```{.r .cell-code}\npred_joint_map(\"pregnant_women\")\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-11-2.png){width=672}\n:::\n:::\n\n\n\n\n============================================================\n\n**Part 2A — Joint modelling with multiple likelihoods (Binomial + Poisson)**\n\n============================================================\n\n1)  Prepare the two datasets and create the mesh\n\nHere we used the binomial and poisson malaria data: - spatial_binom with n_pos, n_tested - spatial_pois with cases, population\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Example: take children as binomial and pretend pregnant are poisson (toy)\nbinom_dat <- read_csv(\"data/spatial_binomial_data.csv\") \npois_dat <- read_csv(\"data/spatial_poisson_data.csv\")\n\nbinom_sf <- st_as_sf(binom_dat, coords = c(\"utm_x\",\"utm_y\"), crs = 32632)\npois_sf  <- st_as_sf(pois_dat,  coords = c(\"utm_x\",\"utm_y\"), crs = 32632)\n\n\nmesh_binom <- inla.mesh.2d(\nloc = st_coordinates(binom_sf),\nmax.edge = c(100000, 200000), # inner and outer triangle sizes\ncutoff = 20000,  # merge points closer than 20km\noffset = c(50000, 200000)  # extend mesh beyond convex hull\n)\n\nplot(mesh_binom)\npoints(st_coordinates(binom_sf), col=\"red\", pch=16, cex = 0.4)\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n\n```{.r .cell-code}\n####\nmesh_pois <- inla.mesh.2d(\nloc = st_coordinates(binom_sf),\nmax.edge = c(100000, 200000), # inner and outer triangle sizes\ncutoff = 20000,  # merge points closer than 20km\noffset = c(50000, 200000)  # extend mesh beyond convex hull\n)\n\nplot(mesh_pois)\npoints(st_coordinates(binom_sf), col=\"red\", pch=16, cex = 0.4)\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-12-2.png){width=672}\n:::\n\n```{.r .cell-code}\n# Mesh on all locations\nall_coords <- rbind(st_coordinates(binom_sf), st_coordinates(pois_sf))\n\nmesh_joint <- inla.mesh.2d(\n  loc = all_coords,\n  max.edge = c(80000, 250000),\n  cutoff   = 20000,\n  offset   = c(100000, 200000)\n)\n\nplot(mesh_joint); points(all_coords, pch = 16, cex = 0.4, col=\"red\")\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-12-3.png){width=672}\n:::\n:::\n\n\n\n\n2)  Shared + likelihood-specific spatial fields\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde_shared <- inla.spde2.pcmatern(\n  mesh = mesh_joint,\n  prior.range = c(300000, 0.5),\n  prior.sigma = c(1, 0.5)\n)\n\nspde_binom <- inla.spde2.pcmatern(\n  mesh = mesh_binom,\n  prior.range = c(200000, 0.5),\n  prior.sigma = c(1, 0.5)\n)\n\nspde_pois <- inla.spde2.pcmatern(\n  mesh = mesh_pois,\n  prior.range = c(200000, 0.5),\n  prior.sigma = c(1, 0.5)\n)\n```\n:::\n\n\n\n\n3)  Fit a multi-likelihood model in inlabru\n\nKey idea: use like() twice, and call bru() once.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Components: shared + outcome-specific fields\ncmp <- ~\n  Intercept_binom(1) + Intercept_pois(1) + \n  elevation + ndvi + urban +\n  shared(geometry, copy = \"binom_field\", fixed = FALSE) +\n  binom_field(geometry, model = spde_binom) +\n  pois_field(geometry,  model = spde_pois)\n\n# Likelihood 1: binomial prevalence\nlike_binom <- like(\n  formula = n_pos ~ Intercept_binom + elevation + ndvi + urban +\n  binom_field,\n  family  = \"binomial\",\n  data    = binom_sf,\n  Ntrials = binom_sf$n_tested\n)\n\n# Likelihood 2: poisson cases with offset(log(population))\nlike_pois <- like(\n  formula = cases ~ Intercept_pois + elevation + ndvi + urban +\n  shared +\n  pois_field, # + offset(log(population)),\n  family  = \"poisson\",\n  data    = pois_sf,\n  E = pois_sf$population\n)\n\nfit_multi <- bru(\n  components = cmp,\n  like_binom,\n  like_pois,\n  options = list(control.compute = list(dic = TRUE, waic = TRUE))\n)\n\nsummary(fit_multi)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nIntercept_binom: main = linear(1)\nelevation: main = linear(elevation)\nndvi: main = linear(ndvi)\nurban: main = linear(urban)\nbinom_field: main = spde(geometry)\nIntercept_pois: main = linear(1)\nshared(=binom_field): main = unknown(geometry)\npois_field: main = spde(geometry)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: n_pos ~ Intercept_binom + elevation + ndvi + urban + binom_field\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[Intercept_binom, elevation, ndvi, urban, binom_field], latent[] \n  Model tag: <No tag>\n    Family: 'poisson'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: cases ~ Intercept_pois + elevation + ndvi + urban + shared + pois_field\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[Intercept_pois, elevation, ndvi, urban, shared, pois_field], latent[] \nTime used:\n    Pre = 1.13, Running = 10.2, Post = 0.285, Total = 11.6 \nFixed effects:\n                  mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nIntercept_binom -2.422 0.714     -3.790   -2.437     -0.957 -2.434   0\nelevation       -0.002 0.001     -0.004   -0.002      0.000 -0.002   0\nndvi             1.935 1.044     -0.101    1.917      4.053  1.915   0\nurban            0.556 0.045      0.468    0.556      0.646  0.556   0\nIntercept_pois  -6.836 0.753     -8.463   -6.805     -5.428 -6.813   0\n\nRandom effects:\n  Name\t  Model\n    binom_field SPDE2 model\n   pois_field SPDE2 model\n   shared Copy\n\nModel hyperparameters:\n                           mean       sd 0.025quant  0.5quant 0.975quant\nRange for binom_field  3.57e+05 8.09e+04   2.29e+05  3.46e+05   5.45e+05\nStdev for binom_field  1.40e+00 2.48e-01   9.90e-01  1.37e+00   1.96e+00\nRange for pois_field   6.70e+05 2.72e+05   3.23e+05  6.13e+05   1.37e+06\nStdev for pois_field   7.08e-01 1.74e-01   4.45e-01  6.82e-01   1.12e+00\nBeta for shared       -3.20e-02 7.90e-02  -1.90e-01 -3.20e-02   1.22e-01\n                           mode\nRange for binom_field  3.24e+05\nStdev for binom_field  1.31e+00\nRange for pois_field   5.07e+05\nStdev for pois_field   6.25e-01\nBeta for shared       -3.00e-02\n\nDeviance Information Criterion (DIC) ...............: 2536.98\nDeviance Information Criterion (DIC, saturated) ....: 819.91\nEffective number of parameters .....................: 200.02\n\nWatanabe-Akaike information criterion (WAIC) ...: 2562.60\nEffective number of parameters .................: 173.60\n\nMarginal log-Likelihood:  -1463.36 \n is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\n4)  Predict (example: prevalence surface from the binomial part)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_grid <- read_csv(\"data/prediction_grid_utm.csv\") %>%\nst_as_sf(coords=c(\"utm_x\",\"utm_y\"), crs=32632)\n\npred_binom_multi <- predict(\nfit_multi,\nnewdata = pred_grid,\nformula = ~ plogis(Intercept_binom + elevation + ndvi + urban + binom_field),\nn.samples = 1000\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npred_binom_r <- st_rasterize(pred_binom_multi[\"mean\"], dx=10000, dy=10000)\npred_binom_r <- pred_binom_r[st_union(nga_admin1)]\nggplot() +\n  geom_stars(data=pred_binom_r, na.rm = TRUE) +\n  geom_sf(data=nga_admin1, fill=NA, color = \"black\") +\n  coord_sf() +\n  scale_fill_viridis_c(name = \"Predicted\\nprevalence\", na.value = NA) +\n  theme_minimal() +\n  theme(\n    panel.background = element_rect(fill = \"white\", colour = NA),\n    plot.background  = element_rect(fill = \"white\", colour = NA),\n    panel.grid       = element_blank()\n  )\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n\n============================================================\n\n**Part 1B — Non-stationary spatial process (mixture of two SPDEs)**\n\n============================================================ We’ll fit a non-stationary field using a mixture of two spatial fields:\n\n-   one smooth / long-range SPDE\n-   one rough / short-range SPDE\n-   a spatially varying weight w(s) controlling mixture\n\nThis is a simple, teachable non-stationary construction.\n\n1.  Prepare data and a mesh\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nns_dat <- nonstat_malaria |>\nmutate(\ny = n_pos,\nn = n_tested\n)\n\nlocs_ns <- nonstat_malaria_sf\n\nmesh_ns <- inla.mesh.2d(\nloc = st_coordinates(locs_ns),\nmax.edge = c(80000, 250000),\ncutoff = 20000,\noffset = c(100000, 200000)\n)\n\nplot(mesh_ns)\npoints(st_coordinates(locs_ns), pch = 16, cex = 0.4, col= \"red\")\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n\n2.  Two SPDEs: smooth and rough\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde_smooth <- inla.spde2.pcmatern(\nmesh = mesh_ns,\nprior.range = c(600000, 0.5),   # long range\nprior.sigma = c(1, 0.5)\n)\n\nspde_rough <- inla.spde2.pcmatern(\nmesh = mesh_ns,\nprior.range = c(200000, 0.5),   # short range\nprior.sigma = c(1, 0.5)\n)\n```\n:::\n\n\n\n\n3.  Build a spatially varying weight w(s)\n\nDefine w(s) as a simple function of northing (utm_y). (You can later replace this with a covariate surface.)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Normalised northing in [0,1]\n\nns_dat <- ns_dat |>\nmutate(\nw = (utm_y - min(utm_y)) / (max(utm_y) - min(utm_y)),\nw = pmin(pmax(w, 0), 1)\n) %>% st_as_sf(coords=c(\"utm_x\",\"utm_y\"), crs=32632)\nhead(ns_dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 14 fields\nGeometry type: POINT\nDimension:     XY\nBounding box:  xmin: -182831.5 ymin: 573963.7 xmax: 1048433 ymax: 1300816\nProjected CRS: WGS 84 / UTM zone 32N\n# A tibble: 6 × 15\n     id n_tested n_pos prevalence_true S_nonstationary weight_north S_smooth\n  <dbl>    <dbl> <dbl>           <dbl>           <dbl>        <dbl>    <dbl>\n1     1      164    30           0.152         -0.793        0.168    -0.273\n2     2      198    69           0.342         -0.0743       0.813     0.405\n3     3      143    40           0.278         -0.0372       0.231     0.169\n4     4       62    14           0.210         -0.0809       0.0903   -0.294\n5     5      160    30           0.170         -0.857        0.481    -0.173\n6     6      197    44           0.260         -0.0663       0.425     0.159\n# ℹ 8 more variables: S_rough <dbl>, elevation <dbl>, ndvi <dbl>, urban <dbl>,\n#   y <dbl>, n <dbl>, w <dbl>, geometry <POINT [m]>\n```\n\n\n:::\n:::\n\n\n\n\n4.  Fit non-stationary mixture model\n\nWe model:\n\n$$\\eta = \\beta_0 + \\beta^\\top x(s) + \\omega(s) S_{smooth} + (1- \\omega(s)) S_{rough}(s)$$\n\nIn inlabru we do this by multiplying the fields by covariates w and 1-w.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncmp_ns <- y ~\n1 + elevation + ndvi + urban +\nsmooth(geometry, model = spde_smooth, weights = w) +\nrough(geometry, model = spde_rough,  weights = I(1 - w))\n\nfit_ns <- bru(\ncomponents = cmp_ns,\nfamily = \"binomial\",\ndata = ns_dat,\nNtrials = ns_dat$n,\noptions = list(control.compute = list(dic = TRUE, waic = TRUE))\n)\n\nsummary(fit_ns)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nelevation: main = linear(elevation)\nndvi: main = linear(ndvi)\nurban: main = linear(urban)\nsmooth: main = spde(geometry), scale(w)\nrough: main = spde(geometry), scale(I(1 - w))\nIntercept: main = linear(1)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: y ~ elevation + ndvi + urban + smooth + rough + Intercept\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[elevation, ndvi, urban, smooth, rough, Intercept], latent[] \nTime used:\n    Pre = 1.34, Running = 7.78, Post = 0.47, Total = 9.59 \nFixed effects:\n            mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nelevation -0.002 0.001     -0.004   -0.002      0.000 -0.002   0\nndvi       1.440 0.965     -0.688    1.527      3.117  1.677   0\nurban      0.320 0.035      0.251    0.320      0.389  0.320   0\nIntercept -1.253 0.363     -1.957   -1.257     -0.529 -1.257   0\n\nRandom effects:\n  Name\t  Model\n    smooth SPDE2 model\n   rough SPDE2 model\n\nModel hyperparameters:\n                     mean       sd 0.025quant 0.5quant 0.975quant     mode\nRange for smooth 6.92e+05 2.65e+05   3.28e+05 6.42e+05   1.35e+06 5.52e+05\nStdev for smooth 8.39e-01 2.48e-01   4.70e-01 8.00e-01   1.44e+00 7.23e-01\nRange for rough  1.40e+05 4.98e+04   6.81e+04 1.32e+05   2.62e+05 1.16e+05\nStdev for rough  5.80e-01 8.60e-02   4.31e-01 5.73e-01   7.68e-01 5.58e-01\n\nDeviance Information Criterion (DIC) ...............: 1928.91\nDeviance Information Criterion (DIC, saturated) ....: 452.02\nEffective number of parameters .....................: 143.07\n\nWatanabe-Akaike information criterion (WAIC) ...: 1925.73\nEffective number of parameters .................: 107.72\n\nMarginal log-Likelihood:  -1069.76 \n is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\n5.  Predict and map (clipped to Nigeria)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_grid_ns <- read_csv(\"data/prediction_grid_utm.csv\") %>% \nmutate(w = (utm_y - min(utm_y)) / (max(utm_y) - min(utm_y)),\nw = pmin(pmax(w, 0), 1)) %>%\nst_as_sf(coords=c(\"utm_x\",\"utm_y\"), crs=32632)\n\n\npred_ns_sf <- predict(fit_ns, newdata = pred_grid_ns, n.samples = 200,\n                      formula = ~ plogis(Intercept + elevation + ndvi + urban +\nw*smooth + (1-w)*rough)) |>\nrename(prev_mean = mean)\npred_ns_rast <- st_rasterize(pred_ns_sf[\"prev_mean\"], dx = 20000, dy = 20000)\npred_ns_rast_ng <- pred_ns_rast[st_union(nga_admin1)]\n\nggplot() +\ngeom_stars(data = pred_ns_rast_ng, na.rm = TRUE) +\ngeom_sf(data = nga_admin1, fill = NA, colour = \"black\", linewidth = 0.25) +\ncoord_sf(expand = FALSE) +\nscale_fill_viridis_c(name = \"Predicted\\nprevalence\", na.value = NA) +\ntheme_minimal() +\ntheme(panel.grid = element_blank(),\npanel.background = element_rect(fill = \"white\", colour = NA),\nplot.background  = element_rect(fill = \"white\", colour = NA)) +\nlabs(title = \"Non-stationary mixture model: posterior mean prevalence\")\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n\n\n6.  (Optional) Visualise the weight surface $\\omega(s)$\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nw_rast <- st_rasterize(pred_ns_sf[\"w\"], dx = 20000, dy = 20000)[st_union(nga_admin1)]\n\nggplot() +\ngeom_stars(data = w_rast, na.rm = TRUE) +\ngeom_sf(data = nga_admin1, fill = NA, colour = \"black\", linewidth = 0.25) +\ncoord_sf(expand = FALSE) +\nscale_fill_viridis_c(name = \"w(s)\", limits = c(0, 1), na.value = NA) +\ntheme_minimal() +\ntheme(panel.grid = element_blank(),\npanel.background = element_rect(fill = \"white\", colour = NA),\nplot.background  = element_rect(fill = \"white\", colour = NA)) +\nlabs(title = \"Spatially varying weight w(s): smooth (north) → rough (south)\")\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\n\n\n============================================================\n\n**Part 1B — Non-stationary SPDE with structured range**\n\n============================================================\n\nHere we make the SPDE range depend on a covariate at the mesh vertices by modelling log(kappa(s)) as: $$\\log(\\kappa(s)) = \\theta_0 + \\theta_1 z(s)$$ and since range(s) = $\\sqrt(8)/\\kappa(s)$, this gives a spatially varying range.\n\n1)  Mesh + vertex covariate\n\nUse something interpretable like northing (y) or a “ecological gradient”.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Mesh for nonstationary dataset\ncoords_ns <- st_coordinates(nonstat_malaria_sf)\n\nmesh_ns <- inla.mesh.2d(\n  loc = coords_ns,\n  max.edge = c(80000, 250000),\n  cutoff   = 20000,\n  offset   = c(100000, 200000)\n)\n\n# Vertex covariate: scaled northing at mesh vertices\nz_vert <- scale(mesh_ns$loc[,2])[,1]   # mesh vertex y coordinate (UTM northing)\n\n# Basis matrices for spatially varying kappa and/or tau\n# Here: 2 hyperparameters for kappa: intercept + slope*z\nB_kappa <- cbind(1, z_vert)\n\n# Keep tau constant (1 parameter) OR also vary it; here constant:\nB_tau <- matrix(1, nrow = nrow(B_kappa), ncol = 1)\n```\n:::\n\n\n\n\n2)  Build B.tau / B.kappa with 4 columns\n\nHere we use the Lindgren/Rue parameterisation.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnu <- 1\nalpha <- nu + 2/2\n\n# constants for the SPDE parameterisation (same approach as the book)\nlogkappa0 <- log(8 * nu) / 2\n\nlogtau0 <- (lgamma(nu) - lgamma(alpha) - log(4*pi)) / 2\nlogtau0 <- logtau0 - logkappa0\n\nB_tau   <- cbind(logtau0,  -1,  nu,  nu * z_vert)\nB_kappa <- cbind(logkappa0, 0,  -1, -1 * z_vert)\n```\n:::\n\n\n\n\n\n\n\n3)  Build a non-stationary SPDE using inla.spde2.matern\n\nWe specify priors for the theta parameters. (These are on log-scales internally.)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspde_ns <- inla.spde2.matern(\n  mesh = mesh_ns,\n  B.kappa = B_kappa,\n  B.tau   = B_tau,\n  theta.prior.mean = c(log(1/300000), 0, 0),   # (kappa intercept), (kappa slope), (tau intercept)\n  theta.prior.prec = c(1, 1, 1)                # weak-ish priors, Increasing theta.prior.prec tightens the prior (less variation).\n  # The seco4)  Predict and mapnd entry in theta.prior.mean / prec controls how strongly the range can vary with z.\n)\n```\n:::\n\n\n\n\n4)  Fit binomial model with this structured-range SPDE\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncmp_ns_struct <- y ~\n  1 + elevation + ndvi + urban +\n  field_ns(geometry, model = spde_ns)\n\nfit_ns_struct <- bru(\n  components = cmp_ns_struct,\n  family = \"binomial\",\n  data = ns_dat,\n  Ntrials = ns_dat$n_tested,\n  options = list(control.compute = list(dic = TRUE, waic = TRUE))\n)\n\nsummary(fit_ns_struct)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ninlabru version: 2.13.0.9024 \nINLA version: 25.12.02 \nLatent components:\nelevation: main = linear(elevation)\nndvi: main = linear(ndvi)\nurban: main = linear(urban)\nfield_ns: main = spde(geometry)\nIntercept: main = linear(1)\nObservation models:\n  Model tag: <No tag>\n    Family: 'binomial'\n    Data class: 'sf', 'tbl_df', 'tbl', 'data.frame'\n    Response class: 'numeric'\n    Predictor: y ~ elevation + ndvi + urban + field_ns + Intercept\n    Additive/Linear/Rowwise: TRUE/TRUE/TRUE\n    Used components: effect[elevation, ndvi, urban, field_ns, Intercept], latent[] \nTime used:\n    Pre = 0.768, Running = 1.69, Post = 0.553, Total = 3.01 \nFixed effects:\n            mean    sd 0.025quant 0.5quant 0.975quant   mode kld\nelevation -0.001 0.000     -0.002   -0.001     -0.001 -0.001   0\nndvi       2.963 0.067      2.831    2.963      3.094  2.963   0\nurban      0.265 0.024      0.219    0.265      0.311  0.265   0\nIntercept -1.700 0.086     -1.867   -1.700     -1.532 -1.700   0\n\nRandom effects:\n  Name\t  Model\n    field_ns SPDE2 model\n\nModel hyperparameters:\n                      mean   sd 0.025quant 0.5quant 0.975quant   mode\nTheta1 for field_ns -12.61 1.00     -14.58   -12.61     -10.64 -12.61\nTheta2 for field_ns   0.00 1.00      -1.97     0.00       1.97   0.00\nTheta3 for field_ns   0.00 1.00      -1.97     0.00       1.97   0.00\n\nDeviance Information Criterion (DIC) ...............: 3488.63\nDeviance Information Criterion (DIC, saturated) ....: 2011.74\nEffective number of parameters .....................: 4.00\n\nWatanabe-Akaike information criterion (WAIC) ...: 3514.04\nEffective number of parameters .................: 28.89\n\nMarginal log-Likelihood:  -1773.36 \n is computed \nPosterior summaries for the linear predictor and the fitted values are computed\n(Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')\n```\n\n\n:::\n:::\n\n\n\n\n5)  Predict and map\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_ns_sf <- predict(fit_ns_struct, newdata = pred_grid_ns, n.samples = 200, \n                      ~ plogis(Intercept + elevation + ndvi + urban + field_ns)) |>\n  rename(prev_mean = mean)\n\npred_rast <- st_rasterize(pred_ns_sf[\"prev_mean\"], dx = 20000, dy = 20000)\npred_rast_ng <- pred_rast[st_union(nga_admin1)]   # mask outside Nigeria\n\n# --- (D) Plot ---\nggplot() +\n  geom_stars(data = pred_rast_ng, na.rm = TRUE) +\n  geom_sf(data = nga_admin1, fill = NA, colour = \"black\", linewidth = 0.25) +\n  coord_sf(expand = FALSE) +\n  scale_fill_viridis_c(name = \"Predicted\\nprevalence\", na.value = NA) +\n  theme_minimal() +\n  theme(\n    panel.grid = element_blank(),\n    panel.background = element_rect(fill = \"white\", colour = NA),\n    plot.background  = element_rect(fill = \"white\", colour = NA)\n  ) +\n  labs(\n    title = \"Posterior mean malaria prevalence\",\n    subtitle = \"Non-stationary SPDE with structured range\"\n  )\n```\n\n::: {.cell-output-display}\n![](day2_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n\n\n## Summary (Day 2)\n\nJoint model: shared + group-specific spatial structure, two outcomes in one model\n\nNon-stationary model: mixture of SPDEs with a spatially varying weight and structured range.\n\nMapping: predictions rasterised and clipped to Nigeria boundary\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}